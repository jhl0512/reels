<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="youtube_sample_globals.css" rel="stylesheet" />
  <link href="yotuube_sample.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    body {
      padding-top: env(safe-area-inset-top);
    }
    #container {
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #container::-webkit-scrollbar {
      display: none;
    }
    .video {
      position: relative;
      scroll-snap-align: start;
      height: 100vh;
      overflow: hidden;
    }
    .video video.video-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      pointer-events: none;
    }
    .video > * {
      position: relative;
      z-index: 1;
    }
    #loading {
      text-align: center;
      padding: 8px;
      background: #fff;
      color: #333;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="video" id="video-template">
      <div class="top">
        <!-- icons -->
      </div>
      <div class="body">
        <div class="left">
          <div class="id">
            <div class="ellipse"></div>
            <div class="id-text"></div>
          </div>
          <p class="title-text"></p>
          <div class="music">
            <!-- music icon -->
            <div class="music-text"></div>
            <div class="rectangle-1"></div>
          </div>
        </div>
        <div class="right">
          <!-- buttons -->
          <div class="rectangle"></div>
        </div>
      </div>
    </div>
    <div id="loading">로딩 중...</div>
  </div>
  <script>
    const categories = ['트와이스 다현', '땅울림'];
    const container = document.getElementById('container');
    const loading = document.getElementById('loading');
    const template = document.getElementById('video-template');
    template.removeAttribute('id');
    container.removeChild(template);

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(',').map(c => c.trim());
        let o = {};
        headers.forEach((h, i) => o[h] = cols[i] || '');
        return o;
      });
    }

    function createPost(data) {
      const post = template.cloneNode(true);
      const bg = document.createElement('video');
      bg.className = 'video-bg';
      bg.src = data['MP4 URL'];
      bg.autoplay = true;
      bg.loop = true;
      bg.playsInline = true;
      bg.muted = true;
      post.prepend(bg);

      post.querySelector('.id-text').textContent = data['ID'];
      post.querySelector('.title-text').textContent = data['TITLE'];
      post.querySelector('.music-text').textContent = data['MUSIC'];
      return post;
    }

    async function loadAll() {
      for (const cat of categories) {
        try {
          const res = await fetch(`${cat}.csv`);
          if (!res.ok) throw new Error(cat + '.csv 로드 실패');
          const text = await res.text();
          parseCSV(text).forEach(row => container.appendChild(createPost(row)));
        } catch (err) {
          console.error(err);
        }
      }
      loading.style.display = 'none';
      updateAudio();
    }

    function updateAudio() {
      const videos = document.querySelectorAll('.video');
      const containerRect = container.getBoundingClientRect();
      videos.forEach(video => {
        const rect = video.getBoundingClientRect();
        const videoEl = video.querySelector('video');
        const fullyVisible = rect.top >= containerRect.top && rect.bottom <= containerRect.bottom;
        if (videoEl) {
          videoEl.muted = !fullyVisible;
          if (fullyVisible) videoEl.play();
          else videoEl.pause();
        }
      });
    }

    let isScrolling = false;
    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      if (isScrolling) return;
      isScrolling = true;
      const direction = e.deltaY > 0 ? 1 : -1;
      const videos = [...container.querySelectorAll('.video')];
      const currentScroll = container.scrollTop;
      const viewHeight = container.clientHeight;
      let currentIndex = videos.findIndex(v => Math.abs(v.offsetTop - currentScroll) < viewHeight / 2);
      if (currentIndex === -1) currentIndex = Math.round(currentScroll / viewHeight);
      let targetIndex = Math.max(0, Math.min(videos.length - 1, currentIndex + direction));
      const targetOffset = videos[targetIndex].offsetTop;
      container.scrollTo({ top: targetOffset, behavior: 'smooth' });
      setTimeout(() => {
        isScrolling = false;
        updateAudio();
      }, 600);
    }, { passive: false });

    container.addEventListener('scroll', () => {
      clearTimeout(container._scrollTimeout);
      container._scrollTimeout = setTimeout(updateAudio, 200);
    });

    loadAll();
  </script>
</body>
</html>
